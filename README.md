# **BPI-R4 - Openwrt + Kernel 6.6.94 + MTK-Feeds**

Я наконец нашёл время и завершил новый скрипт сборки 6.6.94, который я уже давно разрабатывал. Цель заключалась в том, чтобы упростить процесс для тестовых сборок и для тех, кто не знаком с системами на базе Linux и просто хочет собрать рабочее образное для своего BPI-R4. Большинство текущих версий, включая ядро 6.6.100, не очень стабильны, и каждый раз, когда я пытаюсь использовать последнюю коммит, я возвращаюсь к версии 6.6.94.

В любом случае, новый скрипт управляет всем процессом от клонирования исходного кода и применения пользовательских патчей до настройки сборки и подготовки пользовательских файлов.

## **Функции**

* **Автоматизированный процесс сборки**: Клонирует нужные версии OpenWrt и патчей от MediaTek с нуля для чистого, воспроизводимого сборки каждый раз.  
* **Гибкие патчи**: Просто применяйте или отключайте патчи для исправления аппаратных проблем (например, SFP, EEPROM), улучшения программного обеспечения и улучшения интерфейса.  
* **Гибкая конфигурация**:  
  * Размещайте свои кастомные конфигурационные файлы (`как wireless, network, firewall или shadow`) в директории `files/`, чтобы они были включены в итоговый образ.  
  * Используйте кастомный файл `.config` (`defconfig`) для определения точного набора пакетов и ядерных модулей для вашей сборки.  
* **Скрипты на первом запуске**: Добавьте скрипты настройки в директорию `scripts/`, которые будут выполняться при первом запуске устройства для автоматизации начальной настройки (например, настройка режима dumb AP).  
* **Проверки безопасности**: Скрипт автоматически конвертирует форматы строк в файлах с помощью `dos2unix`, чтобы предотвратить проблемы при редактировании файлов на системах Windows.

## **Как использовать**

1. **Предварительные требования**: Убедитесь, что у вас есть совместимая среда сборки, например, **Ubuntu 24.04 LTS**. Вам также нужно установить `dos2unix`:  
   `sudo apt update`  
   
   `sudo apt install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget dos2unix swig`

2. **Клонирование репозитория**:

   `git clone https://github.com/Gilly1970/BPI-R4_Openwrt_Plus_MTK.git`  
   
   `sudo chmod 776 -R BPI-R4_Openwrt_Plus_MTK`

3. **Подготовка кастомных файлов**:  
   * Разместите любые кастомные патчи, которые хотите применить, в директорию `patches/`.  
   * Разместите свои конечные конфигурационные файлы (например, shadow, network) в директории `files/etc/` или `files/config/`.  
   * Если у вас есть скрипт первого запуска, разместите его в директории `scripts/`.  
4. **Настройка скрипта сборки**:  
   * Откройте скрипт сборки (например, 6.6.94.Build.sh) в текстовом редакторе.  
   * В начале файла установите переменную `SETUP_SCRIPT_NAME` на имя вашего скрипта первого запуска или оставьте пустым, чтобы отключить его.  
   * Проверьте функцию `apply_patches`, чтобы включить или отключить патчи, комментируя или разкомментируя команды `cp`.  
5. **Запуск скрипта**:  
   * Сделайте скрипт исполняемым:  
     `chmod +x 6.6.94.Build.sh`  
     
   * Запустите скрипт:  
     `./6.6.94.Build.sh`

Процесс сборки начнётся и может занять значительное время в зависимости от производительности вашей системы. После завершения образы прошивки будут находиться в директории `openwrt/bin/targets/mediatek/filogic/`.

## **Настройка**

Этот образ разработан для максимальной гибкости. Ниже перечислены ключевые директории, которые вы можете изменять:

  * `patches/`: Содержит все файлы `.patch` и Makefiles, которые изменяют исходный код. Файл `defconfig`, определяющий выбор пакетов для сборки, также находится здесь.  
  * `files/`: Эта директория отражает корневую файловую систему итогового образа.  
  * `files/etc/`: Для общих конфигурационных файлов, таких как `shadow`.  
  * `files/config/`: Для конфигурационных файлов, специфичных для UCI, таких как `network`, `wireless` и `firewall`.  
  * `scripts/`: Содержит скрипты на языке shell, которые могут быть запущены при первом запуске через механизм `uci-defaults`.

Добавляя или удаляя файлы в этих директориях, вы можете настроить конечную прошивку под свои конкретные потребности, не модифицируя логику основного скрипта сборки.

### **Современные образы для BPI-R4 (sysupgrade/sdcard) доступны на MediaFire**

Образы для BE14 без проблемы с EEPROM — https://www.mediafire.com/file/n3zfy5ywryj3vsf/BPI_R4_Images_without_TX_Power_patches_25.08.2025.zip

Образы для BE14 с проблемой EEPROM — https://www.mediafire.com/file/wqo9c24ktf4h40b/BPI-R4_Images_with_TX_Power_patches_25.08.2025.zip

### **Обновлено с новыми патчами для устранения проблемы с дублированием портов LAN, отображающихся в Luci**

Если вы используете мой образ или любые коммиты OpenWrt-24.10 до ядра 6.6.100 — используйте патч **3703-Gillys-Remove-duplicated-ports.patch**:

  `cp "$SOURCE_PATCH_DIR/3703-Gillys-Remove-duplicated-ports.patch" "$MTK_FEEDS_DIR/autobuild/unified/filogic/24.10/patches-base/"`

Если вы используете коммит OpenWrt-24.10 с ядром 6.6.100 — используйте этот патч вместо предыдущего — **3703-remove-02_network.orig.patch**:

  `cp "$SOURCE_PATCH_DIR/3703-remove-02_network.orig.patch" "$MTK_FEEDS_DIR/autobuild/unified/filogic/24.10/patches-base/"`

### **Заметки об обновлении**

* Я добавил новый патч, опубликованный "moi_eric11" и "Zerogiven", для исправления неисправности BE14 (`999-mt7988a-bananapi-bpi-r4-BE14000-binmode.patch`) — если вы хотите протестировать его?  
*    - Я собрал новый патч отдельно без других патчей, но на моём тестовом BE14 потерял возможность изменять максимальную мощность передачи: ?  
*    - Я собрал снова и включил патч `9997-use-tx_power-from-default-fw-if-EEPROM-contains-0s.patch` так же, как и с патчем `99999_tx_power_check.patch`, но изменения не наблюдались.  
*    - Вернулся к использованию обоих патчей `99999_tx_power_check.patch` и `9997-use-tx_power-from-default-fw-if-EEPROM-contains-0s.patch` для корректной работы моего тестового BE14.
